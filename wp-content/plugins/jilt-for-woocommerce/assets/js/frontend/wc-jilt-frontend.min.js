"use strict";var _createClass=function(){function i(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,a){return e&&i(t.prototype,e),a&&i(t,a),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(function(){var l;function a(){var t,e=this;_classCallCheck(this,a),this.handle_email_bypass=this.handle_email_bypass.bind(this),this.handle_checkout_page=this.handle_checkout_page.bind(this),this.register_email_collection_opt_out=this.register_email_collection_opt_out.bind(this),this.handle_fragments_refreshed=this.handle_fragments_refreshed.bind(this),this.update_cart_data=this.update_cart_data.bind(this),this.update_order=this.update_order.bind(this),this.params=window.wc_jilt_params,null==this.params.email_collection_opt_out&&this.register_email_collection_opt_out(),this.params.capture_email_on_add_to_cart&&this.init_add_to_cart(),l(document.body).on("added_to_cart removed_from_cart updated_cart_totals updated_shipping_method applied_coupon removed_coupon updated_checkout",function(t){return e.update_cart_data(t.type)}),l(document.body).on("wc_fragments_refreshed",function(){return e.handle_fragments_refreshed}),this.params.cart_token&&this.update_cart_data("page load",!0),(t=l("form.woocommerce-checkout, form.checkout")).length&&this.handle_checkout_page(t)}l=jQuery,window.WC_Jilt=(_createClass(a,[{key:"init_add_to_cart",value:function(){var o=this;if(l(document.body).on("added_to_cart.jilt_capture_email",function(t,e,a,i){return o.handle_added_to_cart(i)}),l(document.body).on("click.jilt_capture_email",'[href*="add-to-cart="]',function(t){var e;if(!(e=l(t.target)).is(".ajax_add_to_cart"))return t.preventDefault(),o.handle_added_to_cart(e,!0)}),l("form.cart").length)return this.handle_product_page()}},{key:"handle_added_to_cart",value:function(e){var t,a=this;return t=1<arguments.length&&void 0!==arguments[1]&&arguments[1]?function(){return e[0].click()}:null,this.init_email_capture(e,t),setTimeout(function(){return e.webuiPopover("show")},0),l(".js-wc-jilt-popover-bypass").on("click",function(t){return e.addClass("popover-dismissed"),a.handle_email_bypass(t,e)})}},{key:"handle_product_page",value:function(){var e,t,a;return e=l("button.single_add_to_cart_button"),t=l("form.cart"),a=function(){return e.click()},this.init_email_capture(e,a),t.on("submit.jilt_capture_email",function(t){return!!e.hasClass("popover-shown")||t.preventDefault()})}},{key:"init_email_capture",value:function(e){var t,a,i,o,n=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return i=l("input.js-wc-jilt-popover-email"),t=l(".wc-jilt-popover-email-addon"),a=t.find(".js-wc-jilt-popover-email-icon"),o=t.find(".js-wc-jilt-popover-email-typing-indicator"),e.webuiPopover({title:this.params.add_to_cart_title,animation:"pop",url:"#wc-jilt-popover-content",onShow:function(){return e.addClass("popover-shown"),i.focus(),t.width(t.height())},onHide:function(){return n.is_valid_email(i.val())||e.hasClass("popover-dismissed")||n.handle_email_bypass(null,e,r),e.webuiPopover("destroy")}}),i.typeWatch({callback:function(t){return t?(a.hide(),o.show()):(o.hide(),a.show())},wait:150,captureLength:1}),i.typeWatch({callback:function(t){if(n.is_valid_email(t))return o.hide(),a.show().removeClass("dashicons-email").addClass("dashicons-yes wc-jilt-email-success"),setTimeout(function(){return e.webuiPopover("hide"),n.terminate_add_to_cart(),n.set_customer({email:t,email_capture_opt_out:!1},r)},500)},wait:1250,highlight:!0,allowSubmit:!1,captureLength:6}),l(".js-wc-jilt-popover-bypass").on("click",function(t){return e.addClass("popover-dismissed"),n.handle_email_bypass(t,e,r)})}},{key:"handle_email_bypass",value:function(t,e){var a,i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){};return a={add_to_cart_opt_out:!0},null!=t?(t.preventDefault(),l(t.target).hasClass("js-wc-jilt-email-collection-opt-out")&&(a.email_capture_opt_out=!0,this.params.email_collection_opt_out=!0)):a.email_capture_opt_out=!1,e.webuiPopover("destroy"),this.set_customer(a,i),this.terminate_add_to_cart()}},{key:"terminate_add_to_cart",value:function(){if(l(document.body).off("added_to_cart.jilt_capture_email click.jilt_capture_email"),l("form.cart").length)return l("form.cart").off("submit.jilt_capture_email")}},{key:"handle_checkout_page",value:function(t){var e=this;return t.on("focusin select2-open select2:open","input, select",function(t){return e.persist_order_data(t)}),t.on("focusout select2-close select2:close","input, select",function(t){return e.send_order_data(t)}),t.on("change",'[name="payment_method"]',function(t){return e.send_chosen_payment_method(t)}),t.on("change",'[name="order_comments"]',function(t){return e.send_order_note(t)}),l(window).on("unload visibilitychange",function(){return e.send_order_data_before_unload()})}},{key:"register_email_collection_opt_out",value:function(){var e=this;return l("a.js-wc-jilt-email-collection-opt-out:not(.js-wc-jilt-popover-bypass)").on("click",function(t){return t.preventDefault(),l.ajax({method:"POST",url:e.params.ajax_url.toString().replace("%%endpoint%%","jilt_set_customer_email_capture_disallowed"),data:{security:e.params.nonce,email_capture_opt_out:!0},fail:function(t){if(e.params.log_threshold<=100)return console.log(t)},success:function(t){return e.params.log_threshold<=100&&console.log(t),l(".wc-jilt-email-usage-notice").slideToggle().remove(),e.update_order(e.params.cart_token,{customer:{declines_cart_reminders:!0}}),e.params.email_collection_opt_out=!0}})}),l(".wc-jilt-email-usage-notice a.dismiss-link").on("click",function(){return location.reload()})}},{key:"handle_fragments_refreshed",value:function(){var t,e,a,i;if(wc_cart_fragments_params){t=wc_cart_fragments_params.cart_hash_key;try{if(i=!1,e=window.localStorage.getItem(t),a=window.sessionStorage.getItem(t),(i=null!==e&&""!==e)||(i=null!==a&&""!==a),i)return this.update_cart_data("wc_fragments_refreshed")}catch(t){}}}},{key:"update_cart_data",value:function(t){var e,i=this,a=1<arguments.length&&void 0!==arguments[1]&&arguments[1];if(!this.params.email_collection_opt_out&&(this.params.log_threshold<=100&&(e=this.update_locked?"(Locked)":"",null==t&&(t="direct method call"),console.log("update_cart_data() triggered by `"+t+"` "+e)),!this.update_locked))return this.update_locked=!0,l.get(this.params.ajax_url.toString().replace("%%endpoint%%","jilt_get_cart_data")).done(function(t){if(i.params.log_threshold<=100&&console.log(t),t.success&&null!=t.data){if(t.data.cart_token)return i.params.cart_token=t.data.cart_token,i.params.cart_hash!==t.data.cart_hash||!0===a?(i.update_order(i.params.cart_token,t.data.cart),i.params.cart_hash=t.data.cart_hash):i.params.log_threshold<=100?console.log("update_cart_data() aborted - no change in cart hash"):void 0}else null==t.data||!t.data.message||i.params.log_threshold<=500&&console.error("[Jilt] Could not get cart data: "+t.data.message)}).fail(function(t,e,a){if(i.params.log_threshold<=500)return console.error("[Jilt] Could not get cart data: "+a+" ("+e+")")}).always(function(){return i.update_locked=!1})}},{key:"persist_order_data",value:function(t){var e;if(e=l(t.target),this.is_checkout_field(e))return e.val()?e.data("jilt-value",e.val()):void 0}},{key:"send_chosen_payment_method",value:function(t){if(!this.params.email_collection_opt_out)return l.ajax({method:"PATCH",url:""+this.params.orders_endpoint+this.params.cart_token,headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:{client_session:{chosen_payment_method:l(t.target).val()}}})}},{key:"send_order_note",value:function(t){var e;if(!this.params.email_collection_opt_out)return e={cart_token:this.params.cart_token,note:l(t.target).val()},this.update_order(e.cart_token,e)}},{key:"send_order_data",value:function(t){var e,a,i,o,n,r,s;if(!this.params.email_collection_opt_out&&(r=(e=l(t.target)).val(),null!=(n=e.attr("name"))&&this.is_checkout_field(e)&&r&&r!==e.data("jilt-value")&&("account_username"===n&&(this.is_valid_email(l("#billing_email").val())&&(r=l("#billing_email").val()),n="billing_email"),"shipping_email"===n&&(n="billing_email"),("billing_email"!==n||this.is_valid_email(r))&&(a=0===n.indexOf("billing_")?"billing_address":"shipping_address",s=n.replace("billing_","").replace("shipping_",""),null!=(o=this.params.order_address_mapping[s])))))return(i={}).cart_token=this.params.cart_token,i[a]={},i[a][o]=r,"billing_address"==a&&-1<["email","first_name","last_name","phone"].indexOf(o)&&(i.customer={},i.customer[o]=r),this.update_order(i.cart_token,i)}},{key:"send_order_data_before_unload",value:function(){var t,e,a,i,o,n,r;if(!this.params.email_collection_opt_out){for(r in n=""+this.params.orders_endpoint+this.params.cart_token,(e={}).cart_token=this.params.cart_token,e.customer={},e.billing_address={},e.shipping_address={},i=this.params.order_address_mapping)a=i[r],t=l("input[name=billing_"+r+"]").val(),o=l("input[name=shipping_"+r+"]").val(),"email"===r&&o&&(t=t||o,o=null),("email"!==r||this.is_valid_email(t)||(t=l("#account_username").val(),this.is_valid_email(t)))&&(t&&(e.billing_address[a]=t,-1<["email","first_name","last_name"].indexOf(a)&&(e.customer[a]=t)),o&&(e.shipping_address[a]=o));if(!(l.isEmptyObject(e.customer)&&l.isEmptyObject(e.billing_address)&&l.isEmptyObject(e.shipping_address)))return null!=navigator.sendBeacon?(e.auth_token=this.params.public_key,navigator.sendBeacon(n+"/beacon",new Blob([l.param(e)],{type:"application/x-www-form-urlencoded"}))):l.ajax({method:"PUT",url:n,contentType:"application/json",dataType:"text",headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:JSON.stringify(e),async:!1,timeout:750})}}},{key:"update_order",value:function(t,e){var a,i;if(!this.params.email_collection_opt_out)return i=""+this.params.orders_endpoint+t,this.params.log_threshold<=100&&console.log({url:i,data:e}),"string"==typeof e?a="text/plain":(a="application/json",e=JSON.stringify(e)),l.ajax({method:"PUT",url:i,contentType:a,dataType:"text",headers:{Authorization:"Token "+this.params.public_key,"x-jilt-shop-domain":this.params.x_jilt_shop_domain},data:e})}},{key:"is_checkout_field",value:function(t){var e;return null!=(e=t.attr("name"))&&(-1!==e.indexOf("billing_")||-1!==e.indexOf("shipping_")||"account_username"===e)}},{key:"is_valid_email",value:function(t){return/[^\s@]+@[^\s@]+\.[^\s@]+/.test(t)}},{key:"set_customer",value:function(t){var e=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};return l.ajax({method:"POST",url:this.params.ajax_url.toString().replace("%%endpoint%%","jilt_set_customer"),data:{security:this.params.nonce,email:t.email,first_name:t.first_name,last_name:t.last_name,add_to_cart_opt_out:t.add_to_cart_opt_out,email_capture_opt_out:t.email_capture_opt_out},success:function(t){return e.params.log_threshold<=100&&console.log(t),a()},failure:function(t){return e.params.log_threshold<=100&&console.log(t),a()}})}}]),a),window.wc_jilt=new WC_Jilt}).call(void 0);